<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHT22 Sensor Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/5.3.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>DHT22 Sensor Data</h1>
    <p>Temperature: <span id="temp"></span></p>
    <p>Humidity: <span id="humidity"></span></p>
    <canvas id="temperatureChart" width="400" height="200"></canvas>
    <canvas id="humidityChart" width="400" height="200"></canvas>

    <p>Overall Average:</p>
    <p>Temperature: <span id="overallTemp"></span> °C</p>
    <p>Humidity: <span id="overallHumidity"></span> %</p>
    
    <button onclick="downloadCSV()">Download CSV</button>

    <script>
        var socket = io.connect("http://" + document.domain + ":" + location.port + "/sensor");

        var temperatureData = {
            labels: [],
            datasets: [{
                label: "Temperature (°C)",
                data: [],
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
                fill: false
            }]
        };

        var humidityData = {
            labels: [],
            datasets: [{
                label: "Humidity (%)",
                data: [],
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
                fill: false
            }]
        };

        var chartOptions = {
            scales: {
                x: {
                    type: "category",
                    position: "bottom",
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        autoSkip: false
                    }
                },
                y: {
                    min: 0,
                    max: 100,
                    beginAtZero: true
                }
            },
            plugins: {
                filler: {
                    propagate: false
                }
            }
        };

        var temperatureChart = new Chart(document.getElementById("temperatureChart").getContext("2d"), {
            type: "line",
            data: temperatureData,
            options: chartOptions
        });

        var humidityChart = new Chart(document.getElementById("humidityChart").getContext("2d"), {
            type: "line",
            data: humidityData,
            options: chartOptions
        });

        socket.on("sensor_update", function (data) {
            updateSensorData(data.temp, data.humidity);
            updateCharts(data);
            updateOverallAverage();
        });

        function updateSensorData(temp, humidity) {
            temp = temp.toFixed(2);
            humidity = humidity.toFixed(2);
            document.getElementById("temp").innerText = temp;
            document.getElementById("humidity").innerText = humidity;
        }

        function updateCharts(data) {
            var timestamp = new Date(data.timestamp).toISOString();
            temperatureData.labels.push(timestamp);
            humidityData.labels.push(timestamp);

            temperatureData.datasets[0].data.push(data.temp);
            humidityData.datasets[0].data.push(data.humidity);

            if (temperatureData.labels.length > 10) {
                temperatureData.labels.shift();
                humidityData.labels.shift();
                temperatureData.datasets[0].data.shift();
                humidityData.datasets[0].data.shift();
            }

            temperatureChart.update();
            humidityChart.update();
        }

        function updateOverallAverage() {
            var overallTempAvg = calculateAverage(temperatureData.datasets[0].data);
            var overallHumidityAvg = calculateAverage(humidityData.datasets[0].data);

            document.getElementById("overallTemp").innerText = overallTempAvg.toFixed(2);
            document.getElementById("overallHumidity").innerText = overallHumidityAvg.toFixed(2);

            displayWarning("overallTemp", overallTempAvg, 20, 25);
            displayWarning("overallHumidity", overallHumidityAvg, 60, 70);
        }

        function calculateAverage(dataArray) {
            var sum = dataArray.reduce(function (a, b) {
                return a + b;
            }, 0);

            return sum / dataArray.length;
        }

        function displayWarning(elementId, value, lowerLimit, upperLimit) {
            var element = document.getElementById(elementId);
            if (value < lowerLimit || value > upperLimit) {
                element.style.color = "red";
            } else {
                element.style.color = "black";
            }
        }

        var ctxTemperature = document.getElementById("temperatureChart").getContext("2d");
        var ctxHumidity = document.getElementById("humidityChart").getContext("2d");

        ctxTemperature.fillStyle = "rgba(255, 0, 0, 0.2)";
        ctxHumidity.fillStyle = "rgba(255, 0, 0, 0.2)";

        ctxTemperature.fillRect(
            new Date("2024-01-01").getMonth() * (temperatureChart.width / 12),
            0,
            (new Date("2024-12-31").getMonth() + 1) * (temperatureChart.width / 12),
            temperatureChart.height
        );

        ctxHumidity.fillRect(
            new Date("2024-01-01").getMonth() * (humidityChart.width / 12),
            0,
            (new Date("2024-12-31").getMonth() + 1) * (humidityChart.width / 12),
            humidityChart.height
        );

        function downloadCSV() {
            var combinedData = temperatureData.labels.map(function (timestamp, index) {
                var date = new Date(timestamp);
                return {
                    timestamp: timestamp,
                    month: date.toLocaleString('en-US', { month: 'short' }),
                    temperature: temperatureData.datasets[0].data[index],
                    humidity: humidityData.datasets[0].data[index],
                };
            });

            var csvContent = "timestamp,month,temperature,humidity\n";
            combinedData.forEach(function (data) {
                csvContent += `${data.timestamp},${data.month},${data.temperature},${data.humidity}\n`;
            });

            var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            var link = document.createElement("a");

            link.download = "sensor_data_with_month.csv";

            if (link.download !== undefined) {
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                window.navigator.msSaveBlob(blob, "sensor_data_with_month.csv");
            }
        }
    </script>
</body>
</html>
